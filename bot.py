import os
import logging
import io
import base64
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters
from PIL import Image

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É Gemini
try:
    import google.generativeai as genai
    GEMINI_AVAILABLE = True
except ImportError:
    GEMINI_AVAILABLE = False
    logging.warning("Google Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º.")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Gemini
if GEMINI_AVAILABLE and GEMINI_API_KEY:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        AI_ENABLED = True
        logger.info("‚úÖ Gemini API –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
    except:
        AI_ENABLED = False
else:
    AI_ENABLED = False
    logger.warning("‚ö†Ô∏è Gemini –æ—Ç–∫–ª—é—á–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º.")

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º"""
    try:
        await update.message.reply_text("üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –±—É–∫–µ—Ç... –≠—Ç–æ –∑–∞–π–º–µ—Ç 10-20 —Å–µ–∫—É–Ω–¥.")
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
        photo = update.message.photo[-1]
        file = await context.bot.get_file(photo.file_id)
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
        photo_bytes = await file.download_as_bytearray()
        image = Image.open(io.BytesIO(photo_bytes))
        
        logger.info(f"üì∑ –ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ: {image.size[0]}x{image.size[1]}")
        
        # –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        processed_image = enhance_image_for_analysis(image)
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
        if AI_ENABLED:
            response = await analyze_with_gemini_enhanced(processed_image)
        else:
            response = await get_smart_demo_response(image)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await update.message.reply_text(response, parse_mode='HTML')
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞: {e}")
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "1. –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n"
            "2. –ß–µ—Ç–∫–∏–π —Ñ–æ–∫—É—Å\n"
            "3. –ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω –±—É–∫–µ—Ç–∞"
        )

def enhance_image_for_analysis(image):
    """–£–ª—É—á—à–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ AI"""
    try:
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç –∏ —Ä–µ–∑–∫–æ—Å—Ç—å
        from PIL import ImageEnhance
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ RGB –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if image.mode != 'RGB':
            image = image.convert('RGB')
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π
        if max(image.size) < 512:
            new_size = (image.size[0]*2, image.size[1]*2)
            image = image.resize(new_size, Image.Resampling.LANCZOS)
        
        # –£–ª—É—á—à–∞–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç
        enhancer = ImageEnhance.Contrast(image)
        image = enhancer.enhance(1.2)
        
        # –£–ª—É—á—à–∞–µ–º —Ä–µ–∑–∫–æ—Å—Ç—å
        enhancer = ImageEnhance.Sharpness(image)
        image = enhancer.enhance(1.1)
        
        return image
        
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {e}")
        return image

async def analyze_with_gemini_enhanced(image):
    """–£–õ–£–ß–®–ï–ù–ù–´–ô –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Gemini —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º"""
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º—É—é –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        model = genai.GenerativeModel('gemini-1.5-pro')
        
        # –î–ï–¢–ê–õ–¨–ù–´–ô –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        prompt = """
        –¢—ã –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç-—Ñ–ª–æ—Ä–∏—Å—Ç —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
        
        –ê–ù–ê–õ–ò–ó–ò–†–£–ô –≠–¢–û–¢ –ë–£–ö–ï–¢ –¶–í–ï–¢–û–í –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–û–î–†–û–ë–ù–û:
        
        ### –ó–ê–î–ê–ù–ò–ï:
        1. –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –¶–í–ï–¢–û–í:
           - –û–ø—Ä–µ–¥–µ–ª–∏ –¢–û–ß–ù–´–ï –ù–ê–ó–í–ê–ù–ò–Ø –≤–∏–¥–æ–≤ —Ü–≤–µ—Ç–æ–≤ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)
           - –£–∫–∞–∂–∏ —Ü–≤–µ—Ç –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞ (–∫—Ä–∞—Å–Ω—ã–π, –±–µ–ª—ã–π, —Ä–æ–∑–æ–≤—ã–π –∏ —Ç.–¥.)
           - –ï—Å–ª–∏ –µ—Å—Ç—å –∑–µ–ª–µ–Ω—å/–Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ - –Ω–∞–∑–æ–≤–∏ –∏—Ö
        
        2. –ö–û–õ–ò–ß–ï–°–¢–í–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:
           - –ü–æ–¥—Å—á–∏—Ç–∞–π –ü–†–ò–ë–õ–ò–ó–ò–¢–ï–õ–¨–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ê–ñ–î–û–ì–û –≤–∏–¥–∞ —Ü–≤–µ—Ç–æ–≤
           - –£–∫–∞–∂–∏: "–ø—Ä–∏–º–µ—Ä–Ω–æ X-Y —à—Ç." –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞
        
        3. –°–¢–û–ò–ú–û–°–¢–¨ –í –ú–û–°–ö–í–ï (2025 –≥–æ–¥):
           - –†–∞—Å—Å—á–∏—Ç–∞–π —Å—Ç–æ–∏–º–æ—Å—Ç—å –ö–ê–ñ–î–û–ì–û –≤–∏–¥–∞ —Ü–≤–µ—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ
           - –£—á—Ç–∏ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å)
           - –î–æ–±–∞–≤—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏ (300-500 —Ä—É–±)
           - –ò—Ç–æ–≥: "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: XXXX-XXXX —Ä—É–±–ª–µ–π"
        
        4. –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï:
           - –û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ—Ç –±—É–∫–µ—Ç–∞
           - –°—Ç–∏–ª—å –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
           - –î–ª—è –∫–∞–∫–æ–≥–æ —Å–ª—É—á–∞—è –ø–æ–¥—Ö–æ–¥–∏—Ç
           - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É (–∫—Ä–∞—Ç–∫–æ)
        
        ### –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
        üå∏ <b>–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ë–£–ö–ï–¢–ê</b>
        
        <b>üìã –°–û–°–¢–ê–í:</b>
        ‚Ä¢ [–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞ 1] ([—Ü–≤–µ—Ç]): –ø—Ä–∏–º–µ—Ä–Ω–æ X-Y —à—Ç. (~XXX —Ä—É–±/—à—Ç)
        ‚Ä¢ [–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞ 2] ([—Ü–≤–µ—Ç]): –ø—Ä–∏–º–µ—Ä–Ω–æ X-Y —à—Ç. (~XXX —Ä—É–±/—à—Ç)
        ‚Ä¢ –ó–µ–ª–µ–Ω—å: [–≤–∏–¥] (~XXX —Ä—É–±)
        
        <b>üí∞ –°–¢–û–ò–ú–û–°–¢–¨:</b>
        ‚Ä¢ –¶–≤–µ—Ç—ã: XXXX-XXXX —Ä—É–±
        ‚Ä¢ –£–ø–∞–∫–æ–≤–∫–∞: 300-500 —Ä—É–±
        ‚Ä¢ <b>–ò—Ç–æ–≥–æ: XXXX-XXXX —Ä—É–±–ª–µ–π</b>
        
        <b>üé® –û–ü–ò–°–ê–ù–ò–ï:</b>
        [2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ –±—É–∫–µ—Ç–µ]
        
        <b>üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:</b>
        [–∫—Ä–∞—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É]
        
        –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ.
        –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≤–∏–¥–æ–≤.
        """
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–º–ø—Ç
        response = model.generate_content([prompt, image])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        if response.text:
            return response.text
        else:
            return await get_smart_demo_response(image)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ Gemini: {e}")
        return await get_smart_demo_response(image)

async def get_smart_demo_response(image):
    """–£–º–Ω—ã–π –¥–µ–º–æ-–æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    try:
        # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞
        width, height = image.size
        colors = image.getcolors(maxcolors=10000)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        if width > height:
            orientation = "–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π"
        else:
            orientation = "–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π"
        
        # –ü—Ä–æ—Å—Ç–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
        from collections import Counter
        if colors:
            top_colors = sorted(colors, key=lambda x: x[0], reverse=True)[:3]
            color_names = []
            for count, color in top_colors:
                if color[0] > 200 and color[1] < 100 and color[2] < 100:
                    color_names.append("–∫—Ä–∞—Å–Ω—ã–µ")
                elif color[0] > 200 and color[1] > 200:
                    color_names.append("–±–µ–ª—ã–µ/–∫—Ä–µ–º–æ–≤—ã–µ")
                elif color[1] > 150:
                    color_names.append("–∑–µ–ª–µ–Ω—ã–µ/–ª–∏—Å—Ç—å—è")
                elif color[2] > 150:
                    color_names.append("—Å–∏–Ω–∏–µ/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ")
                else:
                    color_names.append("—Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ")
            
            dominant_color = max(set(color_names), key=color_names.count)
        else:
            dominant_color = "—Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ"
        
        # –í—ã–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        if "–∫—Ä–∞—Å–Ω—ã–µ" in dominant_color:
            flower_type = "—Ä–æ–∑—ã"
            count = "7-10"
            price = "2500-3500"
            occasion = "—Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è"
        elif "–±–µ–ª—ã–µ" in dominant_color:
            flower_type = "—Ö—Ä–∏–∑–∞–Ω—Ç–µ–º—ã –∏–ª–∏ –ª–∏–ª–∏–∏"
            count = "9-12"
            price = "2000-3000"
            occasion = "—Å–≤–∞–¥—å–±–∞, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ"
        elif "–∑–µ–ª–µ–Ω—ã–µ" in dominant_color:
            flower_type = "—Å–º–µ—à–∞–Ω–Ω—ã–π –±—É–∫–µ—Ç —Å –∑–µ–ª–µ–Ω—å—é"
            count = "15-20"
            price = "1800-2500"
            occasion = "–æ—Ñ–∏—Å, –¥–æ–º–æ–π, –±–µ–∑ –ø–æ–≤–æ–¥–∞"
        else:
            flower_type = "—Å–º–µ—à–∞–Ω–Ω—ã–π –±—É–∫–µ—Ç"
            count = "11-15"
            price = "2200-3200"
            occasion = "—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        response = f"""
üå∏ <b>–ê–ù–ê–õ–ò–ó –ë–£–ö–ï–¢–ê (–î–ï–ú–û-–†–ï–ñ–ò–ú)</b>

üìä <b>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ñ–æ—Ç–æ:</b>
‚Ä¢ –†–∞–∑–º–µ—Ä: {width}x{height} –ø–∏–∫—Å–µ–ª–µ–π
‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è: {orientation}
‚Ä¢ –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ü–≤–µ—Ç: {dominant_color}

üìã <b>–í–µ—Ä–æ—è—Ç–Ω—ã–π —Å–æ—Å—Ç–∞–≤:</b>
‚Ä¢ {flower_type}: –ø—Ä–∏–º–µ—Ä–Ω–æ {count} —à—Ç.
‚Ä¢ –ó–µ–ª–µ–Ω—å/–Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
‚Ä¢ –£–ø–∞–∫–æ–≤–∫–∞: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è

üí∞ <b>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ú–æ—Å–∫–≤–µ:</b>
‚Ä¢ –¶–≤–µ—Ç—ã: {price} —Ä—É–±
‚Ä¢ –£–ø–∞–∫–æ–≤–∫–∞: 300-500 —Ä—É–±
‚Ä¢ <b>–ò—Ç–æ–≥–æ: {str(int(price.split('-')[0])+300)}-{str(int(price.split('-')[1])+500)} —Ä—É–±–ª–µ–π</b>

üé® <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>
–ö—Ä–∞—Å–∏–≤—ã–π {orientation} –±—É–∫–µ—Ç –∏–∑ {flower_type}. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è {occasion}.

üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>
‚Ä¢ –ü–æ–¥—Ä–µ–∂—å—Ç–µ —Å—Ç–µ–±–ª–∏ –ø–æ–¥ —É–≥–ª–æ–º
‚Ä¢ –ú–µ–Ω—è–π—Ç–µ –≤–æ–¥—É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ –ø—Ä—è–º—ã—Ö —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –ª—É—á–µ–π

‚ö†Ô∏è <i>–≠—Ç–æ –¥–µ–º–æ-–∞–Ω–∞–ª–∏–∑. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Gemini API</i>
        """
        
        return response
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–µ–º–æ-–∞–Ω–∞–ª–∏–∑–∞: {e}")
        return """
üå∏ <b>–ê–ù–ê–õ–ò–ó –ë–£–ö–ï–¢–ê</b>

üìã <b>–°–æ—Å—Ç–∞–≤:</b>
‚Ä¢ –°–º–µ—à–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç—ã: 10-15 —à—Ç.
‚Ä¢ –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∑–µ–ª–µ–Ω—å

üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ú–æ—Å–∫–≤–µ:</b>
‚Ä¢ –¶–≤–µ—Ç—ã: 2000-3000 —Ä—É–±
‚Ä¢ –£–ø–∞–∫–æ–≤–∫–∞: 300-500 —Ä—É–±
‚Ä¢ <b>–ò—Ç–æ–≥–æ: 2300-3500 —Ä—É–±–ª–µ–π</b>

üé® <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>
–ö—Ä–∞—Å–∏–≤—ã–π —Å–≤–µ–∂–∏–π –±—É–∫–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª—É—á–∞—è.

üí° <i>–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ü–≤–µ—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Gemini API</i>
        """

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–∞"""
    text = update.message.text.lower()
    
    if text in ['/start', 'start']:
        ai_status = "‚úÖ <b>–ê–ö–¢–ò–í–ï–ù</b>" if AI_ENABLED else "‚ö†Ô∏è <b>–î–ï–ú–û-–†–ï–ñ–ò–ú</b>"
        
        message = f"""
<b>üå∏ FLOWER ANALYZER BOT üå∏</b>

{ai_status}

üì∏ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –±—É–∫–µ—Ç–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ:</b>
1Ô∏è‚É£ <b>–¢–æ—á–Ω—ã–π —Å–æ—Å—Ç–∞–≤</b> - –≤–∏–¥—ã —Ü–≤–µ—Ç–æ–≤
2Ô∏è‚É£ <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</b> - —Å–∫–æ–ª—å–∫–æ –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∞
3Ô∏è‚É£ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å</b> - —Ü–µ–Ω–∞ –≤ –ú–æ—Å–∫–≤–µ
4Ô∏è‚É£ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b> - –ø–æ —É—Ö–æ–¥—É

üîß <b>–°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:</b>
‚Ä¢ –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
‚Ä¢ –ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω –±—É–∫–µ—Ç–∞
‚Ä¢ –ß–µ—Ç–∫–∏–π —Ñ–æ–∫—É—Å
‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ–Ω

üìä <b>–¢–æ—á–Ω–æ—Å—Ç—å:</b> {'–í—ã—Å–æ–∫–∞—è (AI)' if AI_ENABLED else '–î–µ–º–æ (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API)'}

üì∏ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</b>
        """
        await update.message.reply_text(message, parse_mode='HTML')
    
    elif text in ['/demo', 'demo', '–¥–µ–º–æ']:
        await update.message.reply_text(
            "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –¥–µ–º–æ-–∞–Ω–∞–ª–∏–∑–∞!\n"
            "–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Gemini API –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞.",
            parse_mode='HTML'
        )
    
    else:
        await update.message.reply_text(
            "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –±—É–∫–µ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
            parse_mode='HTML'
        )

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    logger.info("=" * 60)
    logger.info("üöÄ –ó–ê–ü–£–°–ö –£–õ–£–ß–®–ï–ù–ù–û–ì–û FLOWER ANALYZER BOT")
    logger.info(f"ü§ñ Gemini AI: {'–ê–ö–¢–ò–í–ï–ù' if AI_ENABLED else '–î–ï–ú–û-–†–ï–ñ–ò–ú'}")
    logger.info(f"üîë API Key: {'–ï–°–¢–¨' if GEMINI_API_KEY else '–ù–ï–¢'}")
    logger.info("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = ApplicationBuilder() \
        .token(TELEGRAM_TOKEN) \
        .pool_timeout(30) \
        .build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    app.add_handler(MessageHandler(filters.TEXT, handle_text))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º
    logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling(
        drop_pending_updates=True,
        allowed_updates=Update.ALL_TYPES
    )

if __name__ == '__main__':
    main()
